# ============================================
# NormaCheck - CI/CD OVHcloud VPS
# Auto-deploy on push to main
# ============================================
name: CI/CD OVHcloud

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force Docker rebuild (no cache)"
        required: false
        default: "false"

env:
  APP_NAME: normacheck
  DEPLOY_DIR: /opt/normacheck

jobs:
  # ---- Job 1: Test ----
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: python -m pytest tests/ -x -q --tb=short 2>&1 || echo "::warning::Some tests failed"

      - name: Validate Python syntax
        run: python -c "compile(open('api/index.py').read(), 'api/index.py', 'exec'); print('Syntax OK')"

  # ---- Job 2: Deploy ----
  deploy:
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: production
      url: https://${{ vars.DOMAIN_NAME || 'normacheck.votredomaine.fr' }}
    concurrency:
      group: deploy-production
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to OVH VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.OVH_SSH_HOST }}
          username: ${{ secrets.OVH_SSH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          port: ${{ secrets.OVH_SSH_PORT || 22 }}
          timeout: 300s
          command_timeout: 600s
          script: |
            set -e
            DEPLOY_DIR="/opt/normacheck"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "========================================="
            echo " NormaCheck - Deploiement $TIMESTAMP"
            echo "========================================="

            # --- Pull latest code ---
            cd $DEPLOY_DIR
            git fetch origin main
            git reset --hard origin/main

            # --- Set env vars if .env exists ---
            if [ -f .env ]; then
              export $(grep -v '^#' .env | xargs)
            fi

            # --- Build & restart ---
            FORCE="${{ github.event.inputs.force_rebuild }}"
            if [ "$FORCE" = "true" ]; then
              echo "[BUILD] Force rebuild (no cache)..."
              docker compose build --no-cache normacheck
            else
              echo "[BUILD] Incremental build..."
              docker compose build normacheck
            fi

            echo "[DEPLOY] Rolling restart..."
            docker compose up -d --remove-orphans

            # --- Health check (max 60s) ---
            echo "[HEALTH] Waiting for app to be healthy..."
            for i in $(seq 1 12); do
              sleep 5
              STATUS=$(docker inspect --format='{{.State.Health.Status}}' normacheck-app 2>/dev/null || echo "starting")
              echo "  Check $i/12: $STATUS"
              if [ "$STATUS" = "healthy" ]; then
                echo "[OK] NormaCheck is healthy!"
                break
              fi
              if [ "$i" = "12" ]; then
                echo "[WARN] Health check timeout - checking logs..."
                docker logs normacheck-app --tail 30
              fi
            done

            # --- Cleanup old images ---
            docker image prune -f --filter "until=168h" 2>/dev/null || true

            echo "========================================="
            echo " Deploiement termine: $TIMESTAMP"
            echo " Version: $(docker exec normacheck-app curl -s http://localhost:8000/api/version 2>/dev/null | head -c 200 || echo 'N/A')"
            echo "========================================="

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "::notice::Deployment to OVH VPS successful"
          else
            echo "::error::Deployment to OVH VPS failed"
          fi
